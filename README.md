# ATAC-Seq analysis related to the paper: "Lyn in fibroblasts promotes leukemia" (running title)

**Authors:** 
 - **Ali T. Abdallah**: Implementation and Data analysis and management. 
 - **Alexander F. vom Stein**: Experiment performer.

## Introduction
This is a repository of the code related to the analysis of the ATAC-Seq dataset from the publication: 
"Alexander F. vom Stein, Rocio Rebollido-Rios, Anna Lukas, Maximilian Koch, Anton von Lom, Sebastian Reinartz, Daniel Bachurski, France Rose, Katarzyna Bozek, **Ali T. Abdallah**, Viktoria Kohlhas, Julia Saggau, Rebekka Zölzer, Yue Zhao, Christiane Bruns, Paul J. Bröckelmann, Philipp Lohneis, Reinhard Büttner, Björn Häupl, Thomas Oellerich, Phuong-Hien Nguyen, and Michael Hallek. **LYN kinase programs stromal fibroblasts to facilitate leukemic survival via regulation of c-JUN and THBS1**. _Nature Communications_. 2023".

**Reproducibility** of data analysis in scientific research is an important quality metric of scientific research, because it helps ensure the validity and reliability of the results, as well as promoting transparency and trust in the scientific community. When others are able to reproduce the same findings using the same methods and data, it provides evidence that the results are robust and not due to chance or error. This also allows for further investigation and improvement of the study, leading to the advancement of knowledge and the discovery of new insights (See the wiki article on [reproducbility](https://en.wikipedia.org/wiki/Reproducibility) for more details). 

Therefore, this README is a description of (1) data used in the analysis, (2) the method used to analyze the data (3) as well as the steps needed to reproduce the same results.

In the following the outline of the description:
- [Introduction](#introduction)
- [Description of used data](#description-of-used-data)
- [Method description](#method-description)
- [Running the analysis](#running-the-analysis)
- [References](#references)
- [Citation](#citation)

## Description of used data

### Raw data
6 ATAC-Seq libraries generated from samples extracted from HS-5 LYNWT and LYNKO cells cultured under normal growth conditions:
- **KO_R1:** LYN KO cells from human HS-5 cell line.
- **KO_R2:** LYN KO cells from human HS-5 cell line.
- **KO_R3:** LYN KO cells from human HS-5 cell line.
- **WT_R1:** LYN WT cells from human HS-5 cell line.
- **WT_R2:** LYN WT cells from human HS-5 cell line.
- **WT_R3:** LYN WT cells from human HS-5 cell line.

The raw data are stored in the functional genomics data collection (ArrayExpress) with following accession number [E-MTAB-12531](https://www.ebi.ac.uk/biostudies/arrayexpress/studies/E-MTAB-12531#) and could be directly downloaded from the [samples and data section](https://www.ebi.ac.uk/biostudies/arrayexpress/studies/E-MTAB-12531/sdrf) 

### Processed data
- **Peaks**
- **Annotated peaks**
- **Differential accessibility table**
- **Motif table**
- **Footprinting table**

## Method description

**ATAC-sequencing Experimental procedures:** HS-5 LYNWT and LYNKO cells were cultured under normal
growth conditions. Cells were used to perform tagmentation and preparations for
ATAC-sequencing according to the manufacturer’s instructions of the used ATAC-kit
(Active Motif). DNA was isolated respectively and processed and sequenced with 50M
reads, PE100 per sample in the Cologne Center for Genomics following in-house
standards.

**Primary analysis:** The ATAC-seq dataset was analysed on the CHEOPS HPC cluster
of the University of Cologne using nf-core’s (v1.2.1)97 atac-seq pipeline 
(nf-core/atacseq pipeline) in a Singularity environment and the corresponding workflow
management software Nextflow (v21.04.1). Peaks were called using MACS2
(v2.2.7.1) with standard parameters (narrowPeak mode). Consensus peaks
generated by the nf-core/atac-seq pipeline were used for downstream analysis. Counts 
file of consensus peaks was generated using featureCounts (v2.0.1) with standard
parameters using nf-core/atac-seq.

**Differential accessibility analysis:** Peak annotation was performed using the
annotatePeak function of ChIPseeker (v1.30.3) with overlap = ”all”, Homo Sapiens
ensembl database version 104, and otherwise standard parameters. Differential
accessibility analysis was performed using DESeq2 (v1.34.0) with standard
parameters. Normalization of counts for visualization was performed using DESeq2
built-in variance stabilization transformation (vst method) with standard parameters.
Intervals with log2-FC >= 0.56 (Fold Change >= 1.5) and adjusted p-value <= 0.05 were
considered as significant for downstream analyses.

The **motif enrichment** was performed using the motif analysis tool of the python
package Regulatory Analysis Toolbox (RGT) (v0.13.2). In short, the tool implements a
simple Fischer’s exact test for each known human transcription factor from known
databases like Hocomoco104 and JASPAR105. Input region provided are all intervals
generated by ATAC-Seq primary analysis with log2-FC >= 0.56 (Fold Change >= 1.5)
and adjusted p-value <= 0.05 as computed by the differential accessibility analysis.
Background regions used are the universe of all called peaks. The fold change is
computed as ratio of foreground and background relative frequency, where a relative
frequency is defined as number of peaks with a motif match relative to number of peaks
without motif match. Motifs with 15% positive fold change and adjusted p-value <= 0.05
were considered as top significantly enriched motifs in LYNKO versus LYNWT.

The **footprinting analysis** was performed using the footprinting tool from RGT (v0.13.2)
in the atac-seq mode (See HINT-ATAC106). As input, we have used the sorted and
filtered bam files of merged replicates and corresponding narrowPeak files generated
by the nf-core/atac-seq pipeline (internally using macs2). We followed the standard
footprinting procedure to generate tracks as well as lists of motif-predicted binding sites
(mpbs) in bed format for both LYNKO and LYNWT conditions. Finally, we ran the
differential footprinting command of RGT to generate differential activity scores and
corresponding adjusted p-values for each motif. 

## Reproduce the results

### Getting started

If you do not have docker installed on your host system install it first see: https://docs.docker.com/get-docker/,
if you are going to remote into the host running the RStudio server instance in docker only the remote host and not
your ssh client needs to have docker installed.
- Download raw data (fastq files) from the above mentioned repository ([E-MTAB-12531](https://www.ebi.ac.uk/biostudies/arrayexpress/studies/E-MTAB-12531/sdrf) )
- Run the nf-core pipeline using the start_ on our raw data (See accession number of our experiment above)
- Clone this repo to your project directory:
  `git clone git@github.com:ATA82/ATAC_Reprogrammin_of_Fibroblasts.git`
- Create a file in this directory called `.env` which contains `USERNAME=<your username on your host system>`
- Customise the docker-compose.yml file to set the:
	- project/container name - set this to a name for the project to make a new container for the 
                                   project and to make it easier to identify your containers in e.g. `docker ps`
	- project directory - set this to the path on your host system where you have just cloned this repo
	  It is important that you create this directory prior to starting the container as if the project
	  path does not exist it will be owned by the root user by default which will cause permissions issues
	- port - setting a unique port for the container makes it easier to have multiple projects up on 
		 your host at the same time as they will not clash
	- map the cache of renv on the host system to the container. If you don't have a cache you could just select a directory on the host system where the user of rstudio have access to, such as the one used in the docker-compose.yml file. The advantage of selecting an existing cache is given in case you already have most of the package versions on your system.
  There are additional comments in `docker-compose.yml` to aid in setting it up


### Running the analysis
- Start your container with `docker compose up -d`, `-d` is for detach so the container 
  will now run in the background and will even resume following a reboot.
  to stop session use `docker compose down`, add the `--build` flag when starting if you want to 
  trigger a re-build of the container image.
- Connect to your RStudio server session at: localhost:port or 0.0.0.0:port, 
  where port is the port you set in `docker-compose.yml`, in this example it is 4444
  The default user and password are 'rstudio' & '1rstudio' respectively, these are set in `rstudio_docker/rstudio.env`
  note that you can connect to an RStudio server instance running on a remote system to which you have 
  access over ssh by using ssh port forwarding.
  You can forward a port over ssh with a command of the form: `ssh -nNT -L <local port>:<host>:<remote port> <host>`
  e.g. `ssh -nNT -L 4444:abdallah.cecad.uni-koeln.de:4444 aabdallah@aabdallah.cecad.uni-koeln.de`
  you should now be able to access the RStudio server instance at localhost of the ssh client in a web browser.
  (Tip: If working with multiple RStudio containers we may sometimes have issues logging into different sessions at the
  same time opening different sessions using Firefox container tabs fixes this issue)
- Use `renv::restore()` to load the appropriate versions of the R package dependencies from the renv lockfile 
- load the {targets} R package `library(targets)` and run the targets pipeline with `tar_make()`
- After all target objects are created you could switch to R Notebook within the project and Run all chunks.

Customisations can be made within the `_targets.R` file and the R functions files located in `R/`

## References

## Citation
